{{/* Copyright 2024 The Chromium Authors
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file. */}}

{{define "sidebar"}}
{{$currentURL:=.currentURL}}
<form class="data-table-filter"
    action="/steps/" method="GET"
    hx-trigger="change,submit"
    hx-ext-md-filter-chip-as-checkbox>
  <div>
    <div id="paginator">
      Showing {{.itemFirstLogical}}-{{.itemLastLogical}} of {{.itemsLen}}
    </div>
    <div class="page-controls">
      <md-outlined-text-field class="page-number" type="number" name="page" aria-label="Page"
          value="{{.page}}" min="0" max="{{.pageLast}}"></md-outlined-text-field>
      <md-icon-button onclick="this.parentElement.querySelector('.page-number').value = {{.pageFirst}}">
        <md-icon>first_page</md-icon>
      </md-icon-button>
      <md-icon-button onclick="this.parentElement.querySelector('.page-number').stepDown()">
        <md-icon>chevron_left</md-icon>
      </md-icon-button>
      <md-icon-button onclick="this.parentElement.querySelector('.page-number').stepUp()">
        <md-icon>chevron_right</md-icon>
      </md-icon-button>
      <md-icon-button onclick="this.parentElement.querySelector('.page-number').value = {{.pageLast}}">
        <md-icon>last_page</md-icon>
      </md-icon-button>
    </div>
  </div>
  <div class="filter-controls"
      {{/* Ensure state doesn't go out of sync with the backend by swapping this form whenever we see it in a fetched page. */}}
      id="step-filter-controls">
    <md-filled-text-field name="q" type="search" value="{{.outputSearch}}" placeholder="Search outputs"
        oninput="this.querySelector('md-icon-button').style.display = this.value ? 'flex' : 'none'">
      <md-icon slot="leading-icon">search</md-icon>
      <md-icon-button class="clear-text-field" slot="trailing-icon"
          {{if not .output_search}} style="display: none"{{end}} onclick="this.closest('md-filled-text-field').value = ''; this.style.display = 'none'">
        <md-icon>close</md-icon>
      </md-icon-button>
    </md-filled-text-field>
    <h3 id="view-label">view</h3>
    <input type="radio" id="view-all" name="view" value="" />
    <label for="view-all">All Steps</label>
    <input type="radio" id="view-critical-path" name="view" value="criticalPath" />
    <label for="view-critical-path">Critical Path</label>
    <h3 id="action-label">action</h3>
    <md-chip-set aria-labelledby="action-label">
      {{range $key, $count := .actionCounts}}
        {{if gt $count 20}}
        <input type="checkbox" id="action-{{$key}}"
            name="action" value="{{$key}}"{{if urlHasParam $currentURL "action" $key}}checked{{end}}>
        <label for="action-{{$key}}">
          <md-filter-chip label="{{printf "%.25s" $key}} ({{$count}})"{{if urlHasParam $currentURL "action" $key}}selected{{end}}></md-filter-chip>
        </label>
        {{end}}
      {{end}}
    </md-chip-set>
    <h3 id="rule-label">rule</h3>
    <md-chip-set aria-labelledby="rule-label">
      {{range $key, $count := .ruleCounts}}
        <input type="checkbox" id="rule-{{$key}}"
            name="rule" value="{{$key}}"{{if urlHasParam $currentURL "rule" $key}}checked{{end}}>
        <label for="rule-{{$key}}">
          <md-filter-chip label="{{$key}} ({{$count}})"{{if urlHasParam $currentURL "rule" $key}}selected{{end}}></md-filter-chip></label>
      {{end}}
    </md-chip-set>
  </div>
</form>
{{end}}

{{define "content"}}
{{$buildDuration:=.buildDuration}}
<div class="data-table-container">
  <cds-table>
    <cds-table-head>
      <cds-table-header-row>
        <cds-table-header-cell>
          Output
          <cds-table-cell-content>Action</cds-table-cell-content>
        </cds-table-header-cell>
        <cds-table-header-cell>Ready</cds-table-header-cell>
        <cds-table-header-cell>Duration</cds-table-header-cell>
        <cds-table-header-cell>Completion</cds-table-header-cell>
        <cds-table-header-cell>Timeline</cds-table-header-cell>
      </cds-table-header-row>
    </cds-table-head>
    <cds-table-body id="data-table-body">
      {{range .subset}}
      <cds-table-row>
        <cds-table-cell>
          <a href="/steps/{{.StepID}}">{{.Output}}</a>
          <cds-table-cell-content>
            <span class="step-rule">{{.Rule}}</span>
            <span class="step-action">{{.Action}}</span>
          </cds-table-cell-content>
        </cds-table-cell>
        <cds-table-cell>{{formatIntervalMetric .Ready}}</cds-table-cell>
        <cds-table-cell>{{formatIntervalMetric .Duration}}</cds-table-cell>
        <cds-table-cell>{{formatIntervalMetric (addIntervals .Ready .Duration)}}</cds-table-cell>
        <cds-table-cell>
          <svg height="20" class="step-timeline-bar">
            <rect x="{{divIntervalsScaled .Ready $buildDuration 100}}%" y="0"
                width="{{divIntervalsScaled .Duration $buildDuration 100}}%" height="20"
                class="duration-interval" />
          </svg>
        </cds-table-cell>
      </cds-table-row>
      {{end}}
    </cds-table-body>
  </cds-table>
</div>
{{end}}
